name: Sync upstream master

on:
  schedule:
    # UTC cron — 每天 03:00 同步一次（可按需修改）
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      upstream_repo:
        description: 'Upstream repository (owner/repo)，例如: octocat/Hello-World。若留空将使用 env.UPSTREAM_REPO'
        required: false
        default: ''
      upstream_branch:
        description: 'Upstream 分支（默认 master）'
        required: false
        default: 'master'
      strategy:
        description: '同步策略: reset (强制使本仓库与 upstream 分支一致)、merge (合并 upstream 到本地)、rebase (将本地重放到 upstream 之后)'
        required: false
        default: 'merge'

env:
  # 请把下面的占位值改成你要同步的上游仓库（owner/repo）
  UPSTREAM_REPO: 'ACL4SSR/ACL4SSR'
  # 本仓库目标分支（你要把上游内容同步到哪个分支），这里为 master
  TARGET_BRANCH: 'master'
  # 上游默认分支
  UPSTREAM_BRANCH: 'master'
  # 默认策略：merge（会 force push）
  STRATEGY: 'merge'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (完整 history)
        uses: actions/checkout@v4
        with:
          # 用于推送回本仓库（origin）
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ env.TARGET_BRANCH }}

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Prepare inputs 和 environment
        shell: bash
        run: |
          # 优先使用 workflow_dispatch 的输入，其次回退到 env 中的默认值
          UPSTREAM_REPO="${{ github.event.inputs.upstream_repo }}"
          if [ -z "$UPSTREAM_REPO" ]; then UPSTREAM_REPO="${{ env.UPSTREAM_REPO }}"; fi

          UPSTREAM_BRANCH="${{ github.event.inputs.upstream_branch }}"
          if [ -z "$UPSTREAM_BRANCH" ]; then UPSTREAM_BRANCH="${{ env.UPSTREAM_BRANCH }}"; fi

          STRATEGY="${{ github.event.inputs.strategy }}"
          if [ -z "$STRATEGY" ]; then STRATEGY="${{ env.STRATEGY }}"; fi

          TARGET_BRANCH="${{ env.TARGET_BRANCH }}"

          echo "UPSTREAM_REPO=$UPSTREAM_REPO" >> $GITHUB_ENV
          echo "UPSTREAM_BRANCH=$UPSTREAM_BRANCH" >> $GITHUB_ENV
          echo "STRATEGY=$STRATEGY" >> $GITHUB_ENV
          echo "TARGET_BRANCH=$TARGET_BRANCH" >> $GITHUB_ENV

          echo "Will sync from $UPSTREAM_REPO:$UPSTREAM_BRANCH to $TARGET_BRANCH using strategy '$STRATEGY'"

      - name: Add upstream remote 和 fetch
        shell: bash
        run: |
          # 使用 UPSTREAM_TOKEN（可选）访问私有上游
          if [ -n "${{ secrets.UPSTREAM_TOKEN }}" ]; then
            UPSTREAM_URL="https://x-access-token:${{ secrets.UPSTREAM_TOKEN }}@github.com/$UPSTREAM_REPO.git"
          else
            UPSTREAM_URL="https://github.com/$UPSTREAM_REPO.git"
          fi

          # 移除可能存在的 upstream 配置并添加新的
          git remote remove upstream || true
          git remote add upstream "$UPSTREAM_URL"

          # 只拉取需要的分支（深度 1）
          git fetch --no-tags --prune --depth=1 upstream "$UPSTREAM_BRANCH"

      - name: Sync changes (根据策略)
        shell: bash
        run: |
          set -euo pipefail
          echo "开始同步：策略 = $STRATEGY"

          # 确保在目标分支
          git checkout "$TARGET_BRANCH"

          case "$STRATEGY" in
            reset)
              # 将本地分支强制与上游分支一致（覆盖本地历史）
              git reset --hard "upstream/$UPSTREAM_BRANCH"
              # 强推到 origin（使用 --force-with-lease 更安全）
              git push origin "$TARGET_BRANCH" --force-with-lease
              ;;
            merge)
              # 快进或合并上游更改到本地
              if git merge --ff-only "upstream/$UPSTREAM_BRANCH" -m "Fast-forward merge upstream/$UPSTREAM_BRANCH"; then
                echo "Fast-forward 成功"
              else
                git merge "upstream/$UPSTREAM_BRANCH" --no-edit || (echo "Merge 失败，尝试中止" && git merge --abort && exit 1)
              fi
              git push origin "$TARGET_BRANCH"
              ;;
            rebase)
              # 将本地提交移到上游分支之后
              if git rebase "upstream/$UPSTREAM_BRANCH"; then
                git push origin "$TARGET_BRANCH" --force-with-lease
              else
                echo "Rebase 失败，正在尝试中止并恢复"
                git rebase --abort || true
                exit 1
              fi
              ;;
            *)
              echo "Unknown strategy: $STRATEGY"
              exit 2
              ;;
          esac

      - name: 已完成
        run: echo "同步完成"
